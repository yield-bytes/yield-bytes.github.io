<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yield-bytes.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","Pisces | Gemini":240,"width":300,"display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":5,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="&amp;#8195;&amp;#8195;在本博客前面的文章给出redis-cluster模式的配置和测试《一篇文章掌握redis-cluster原理及其部署、测试》，redis还有另外一种failover自动切换的部署方式，也即是本文给出的——Sentinel模式（哨兵模式），这两种方式部署的redis服务其实在普通的项目完全够用，例如个人在Django项目使用的Sentinel模式保证了”查询缓存服务以及一">
<meta property="og:type" content="article">
<meta property="og:title" content="基于Sentinel模式部署高可用Redis">
<meta property="og:url" content="https://yield-bytes.github.io/2019/12/20/%E5%9F%BA%E4%BA%8ESentinel%E6%A8%A1%E5%BC%8F%E9%83%A8%E7%BD%B2%E9%AB%98%E5%8F%AF%E7%94%A8Redis/index.html">
<meta property="og:site_name" content="yield-bytes">
<meta property="og:description" content="&amp;#8195;&amp;#8195;在本博客前面的文章给出redis-cluster模式的配置和测试《一篇文章掌握redis-cluster原理及其部署、测试》，redis还有另外一种failover自动切换的部署方式，也即是本文给出的——Sentinel模式（哨兵模式），这两种方式部署的redis服务其实在普通的项目完全够用，例如个人在Django项目使用的Sentinel模式保证了”查询缓存服务以及一">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2019-12-20T13:31:37.000Z">
<meta property="article:modified_time" content="2020-02-03T04:39:28.000Z">
<meta property="article:tag" content="Sentinel模式">
<meta property="article:tag" content="redis集群">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://yield-bytes.github.io/2019/12/20/%E5%9F%BA%E4%BA%8ESentinel%E6%A8%A1%E5%BC%8F%E9%83%A8%E7%BD%B2%E9%AB%98%E5%8F%AF%E7%94%A8Redis/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>基于Sentinel模式部署高可用Redis | yield-bytes</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="yield-bytes" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">yield-bytes</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">分享与沉淀</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th-large fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://gitee.com/yield-bytes" class="github-corner" title="Follow me on Gitee" aria-label="Follow me on Gitee" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yield-bytes.github.io/2019/12/20/%E5%9F%BA%E4%BA%8ESentinel%E6%A8%A1%E5%BC%8F%E9%83%A8%E7%BD%B2%E9%AB%98%E5%8F%AF%E7%94%A8Redis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://www.linuxprobe.com/wp-content/uploads/2018/06/QQ%E5%9B%BE%E7%89%8720180625205006.png">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="一个非常专注技术总结与分享的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yield-bytes">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          基于Sentinel模式部署高可用Redis
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-12-20 21:31:37" itemprop="dateCreated datePublished" datetime="2019-12-20T21:31:37+08:00">2019-12-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-02-03 12:39:28" itemprop="dateModified" datetime="2020-02-03T12:39:28+08:00">2020-02-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>20k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>18 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>&#8195;&#8195;在本博客前面的文章给出redis-cluster模式的配置和测试<a target="_blank" rel="noopener" href="https://blog.csdn.net/pysense/article/details/100827689">《一篇文章掌握redis-cluster原理及其部署、测试》</a>，redis还有另外一种failover自动切换的部署方式，也即是本文给出的——Sentinel模式（哨兵模式），这两种方式部署的redis服务其实在普通的项目完全够用，例如个人在Django项目使用的Sentinel模式保证了”查询缓存服务以及一些频繁读取配置参数服务“的高可用。对于并发量大的需求，可以使用国内知名Codis——分布式Redis集群代理中间件，可配置规模更大的redis集群服务。</p>
<a id="more"></a>

<h4 id="1、安装redis"><a href="#1、安装redis" class="headerlink" title="1、安装redis"></a>1、安装redis</h4><p>&#8195;&#8195;为保持文章内容完整，这里给出redis的安装过程。两种方式，一种为yum 安装，另外一种下载包安装。这里选择bin包下载安装。目前redis稳定版为5.0.7，tar包为仅为1.7M，不愧为缓冲界的宠儿。安装包放在opt下，个人喜好将所有关开发的相关组件安装包放置于/opt目录，例如前面大数据各个组件的安装包，还是为了方便记忆、管理和查找。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@nn redis-5.0.7]# pwd</span><br><span class="line">/opt/redis-5.0.7</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> wget http://download.redis.io/releases/redis-5.0.7.tar.gz</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> tar xzf redis-5.0.7.tar.gz</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> redis-5.0.7</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make</span></span><br></pre></td></tr></table></figure>

<p>将redis启动命令所在的src路径加入系统变量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@nn redis-5.0.7]# source ~/.bash_profile  </span><br><span class="line">PATH=$PATH:$HOME/bin:/opt/redis-5.0.7/src/  </span><br></pre></td></tr></table></figure>

<p>查看版本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@nn opt]# redis-server -v</span><br><span class="line">Redis server v=5.0.7 sha=00000000:0 malloc=jemalloc-5.1.0 bits=64 build=864a7319aeb56c9b</span><br></pre></td></tr></table></figure>
<p>启动redis-server后台进程：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@nn opt]# redis-server &amp;</span><br><span class="line">[root@nn opt]# ps -ef |grep redis</span><br><span class="line">root      91054  60098  0 11:47 pts/0    00:00:00 redis-server *:6379</span><br><span class="line"></span><br><span class="line">[root@nn opt]# redis-cli </span><br><span class="line">127.0.0.1:6379&gt; set msg 1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get msg</span><br><span class="line">&quot;1&quot;</span><br></pre></td></tr></table></figure>

<h4 id="2、Sentinel-的配置说明"><a href="#2、Sentinel-的配置说明" class="headerlink" title="2、Sentinel 的配置说明"></a>2、Sentinel 的配置说明</h4><h5 id="2-1-官网有关Sentinel模式的基本信息"><a href="#2-1-官网有关Sentinel模式的基本信息" class="headerlink" title="2.1 官网有关Sentinel模式的基本信息"></a>2.1 官网有关Sentinel模式的基本信息</h5><blockquote>
<p>The current version of Sentinel is called <strong>Sentinel 2</strong>，A stable release of Redis Sentinel is shipped since Redis 2.8.<br>Sentinels by default run <strong>listening for connections to TCP port 26379</strong>,<br>If you are using the <code>redis-sentinel</code> executable， you can run Sentinel<br>with the following command line:<br><code>redis-sentinel /path/to/sentinel.conf</code></p>
</blockquote>
<p>redis要求启动Sentinel服务时必须带上其配置文件，否则直接返回启动失败。<br>启动Sentinel模式前的基本要求：</p>
<ul>
<li>You need at least three Sentinel instances for a robust deployment.（至少3个Sentinel实例，多数票选举）</li>
<li>最好在不同物理机上或者虚拟机上启动每个Sentinel 实例（在测试环境下，当然也可在同一台服务器里面，启动不同端口的多个实例也可完成测试。）</li>
<li>Sentinel + Redis distributed system does not guarantee that acknowledged writes are retained during failures，since Redis uses asynchronous replication.（Sentinel+redis分布式集群环境下，节点出现故障时，不保证写一致性，因redis异步复制方式实现集群数据同步）</li>
</ul>
<h5 id="2-2-redis官网Sentinel模式说明"><a href="#2-2-redis官网Sentinel模式说明" class="headerlink" title="2.2 redis官网Sentinel模式说明"></a>2.2 redis官网Sentinel模式说明</h5><p>有些缩写需要说明：</p>
<ul>
<li>Masters are called M1, M2, M3, …, Mn.</li>
<li>replicas are called R1, R2, R3, …, Rn (R stands for <em>replica</em>).（replica也就是slave角色，因为slave有歧视语义，很多中间件不再使用该词描述副角色，例如kafka备份分区的：replica）</li>
<li>Sentinels are called S1, S2, S3, …, Sn.</li>
<li>Clients are called C1, C2, C3, …, Cn.</li>
</ul>
<p>首先看官方首推的 basic setup with three boxes:It is based on three boxes, each box running both a Redis process and a Sentinel process. 每个box代表一个redis节点，确认master失败的选票数为2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">       +----+</span><br><span class="line">       | M1 |</span><br><span class="line">       | S1 |</span><br><span class="line">       +----+</span><br><span class="line">          |</span><br><span class="line">+----+    |    +----+</span><br><span class="line">| R2 |----+----| R3 |</span><br><span class="line">| S2 |         | S3 |</span><br><span class="line">+----+         +----+</span><br><span class="line"></span><br><span class="line">Configuration: quorum &#x3D; 2</span><br></pre></td></tr></table></figure>

<p>If the master M1 fails, S2 and S3 will agree about the failure and will<br>be able to authorize a failover, making clients able to continue.</p>
<p>如果主redis M1宕机（哨兵S1当然也会挂掉），那么其他节点上哨兵S2和哨兵S3发现与S1心跳失败，两者一致同意此时进入故障转移，选举R2为新的master M2。</p>
<p>redis sentinel实现高可用，但也会在某种程度下有丢失有些写数据。例如下面的情况：客户端C1原来与M1连接，写入M1，当M1挂了，到M2起来的这个过程，C1在这一过程写的部分数据会丢失。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">         +----+</span><br><span class="line">         | M1 |</span><br><span class="line">         | S1 | &lt;- C1 (writes will be lost)</span><br><span class="line">         +----+</span><br><span class="line">            |</span><br><span class="line">            &#x2F;</span><br><span class="line">            &#x2F;</span><br><span class="line">+------+    |    +----+</span><br><span class="line">| [M2] |----+----| R3 |</span><br><span class="line">| S2   |         | S3 |</span><br><span class="line">+------+         +----+</span><br></pre></td></tr></table></figure>

<p>&#8195;&#8195;以上情况可通过以下两个配置实现数据丢失最小化。that allows to stop accepting writes if a master detects thatit is no longer able to transfer its writes to the specified number of replicas。<br>这里用到replica关键字单词，在本博客前面kafka文章里面，kafka也有自己的replica名词，不过kafka的replica是指top 分区后的副本，redis这里replica是从服务器（开源界不建议使用slave这个带有歧视的单词）。通过以下设置，只有当前master主机至少还有一个alive的replica才准许外部客户端写入数据。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">min-replicas-to-write 1</span><br><span class="line">min-replicas-max-lag 10</span><br></pre></td></tr></table></figure>

<h4 id="3、一主两从的redis架构配置"><a href="#3、一主两从的redis架构配置" class="headerlink" title="3、一主两从的redis架构配置"></a>3、一主两从的redis架构配置</h4><p>&#8195;&#8195;第2部分的sentinel 2 高可用的前提是基于1主2两从的架构基础上实现的，如下架构，故首先得让一主两从的redis小集群跑起来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">       +----+</span><br><span class="line">       | M1 |</span><br><span class="line">       | S1 |</span><br><span class="line">       +----+</span><br><span class="line">          |</span><br><span class="line">+----+    |    +----+</span><br><span class="line">| R2 |----+----| R3 |</span><br><span class="line">| S2 |         | S3 |</span><br><span class="line">+----+         +----+</span><br><span class="line"></span><br><span class="line">Configuration: quorum &#x3D; 2</span><br></pre></td></tr></table></figure>

<p>&#8195;&#8195;M1为1主，两从：R2、R3，在此基础上，每个节点运行sentinel进程，即可实现redis高可用架构。</p>
<h5 id="3-1-配置主从的redis-conf文件"><a href="#3-1-配置主从的redis-conf文件" class="headerlink" title="3.1 配置主从的redis.conf文件"></a>3.1 配置主从的<strong>redis.conf</strong>文件</h5><p>redis的配置文件的注释有分段说明，这里列出仅需修改的地方：<br>”一主redis“的配置说明：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">################################# NETWORK</span></span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> 绑定本机IP</span></span><br><span class="line">bind 182.0.0.10</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">################################ GENERAL</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 后台守护进程运行</span></span><br><span class="line">daemonize yes</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################### SNAPSHOTTING</span></span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> 存放快照（数据日志文件的目录）dump.rdb</span></span><br><span class="line">dir /opt/redis-5.0.7/data</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">################################ REPLICATION</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1主两从架构里，至少一个有个从服务器在线且在10秒以内延迟，主redis才能对外提供写服务器，否则客户端无法写</span></span><br><span class="line">min-replicas-to-write 1</span><br><span class="line">min-replicas-max-lag 10</span><br><span class="line"><span class="meta">#</span><span class="bash">这里也需设置，因为当该master挂了再重启，变成replica后，需要密码去认证新的master</span></span><br><span class="line">masterauth foo123</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">################################# SECURITY</span></span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> 为master设置认证密码</span></span><br><span class="line">requirepass foo123</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">################################## CLIENTS</span></span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> 按默认</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################# MEMORY MANAGEMENT</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 按默认</span></span><br></pre></td></tr></table></figure>

<p>”2个replica“节点的redis.conf配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">################################# NETWORK</span></span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> 绑定本机IP</span></span><br><span class="line">bind 182.0.0.11</span><br><span class="line"><span class="meta">#</span><span class="bash"> 另外一台从的IP为182.0.0.12</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">################################ GENERAL</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 后台守护进程运行</span></span><br><span class="line">daemonize yes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################### SNAPSHOTTING</span></span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> 存放快照（数据日志文件的目录）dump.rdb</span></span><br><span class="line">dir /opt/redis-5.0.7/data</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">################################ REPLICATION</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 告诉从服务器主服务器的认证密码以及IP端口号，新版redis不再使用slave争议词，原版是slaveof</span></span><br><span class="line">replicaof 182.0.0.10 6379</span><br><span class="line">masterauth foo123</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1主两从架构里，至少一个有个从服务器在线且在10秒以内延迟，主redis才能对外提供写服务器，否则客户端无法写</span></span><br><span class="line">min-replicas-to-write 1</span><br><span class="line">min-replicas-max-lag 10</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">################################# SECURITY</span></span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> 从redis需要密码认证</span></span><br><span class="line">requirepass foo123</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">################################## CLIENTS</span></span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> 按默认</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################# MEMORY MANAGEMENT</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 按默认</span></span><br></pre></td></tr></table></figure>

<h5 id="3-2-启动和测试主从"><a href="#3-2-启动和测试主从" class="headerlink" title="3.2 启动和测试主从"></a>3.2 启动和测试主从</h5><p>启动所有主从redis-server，后台守护进程运行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@p1 opt]# redis-server /opt/redis-5.0.7/redis.conf </span><br></pre></td></tr></table></figure>
<p>注意：<br>如果只启动master，从服务器还未启动，提示没有足够的从服务器在线，无法对外提供写服务。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set test 1</span><br><span class="line">(error) NOREPLICAS Not enough good replicas to write.</span><br></pre></td></tr></table></figure>
<p>这是因为<code>min-replicas-to-write 1</code> 要求最少1个从redis在线后master才能接收客户端写数据。<br>在master set一个key</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@p1 opt]# redis-cli -a foo123</span><br><span class="line">127.0.0.1:6379&gt; set foo 1</span><br><span class="line">​```shell</span><br><span class="line">在两个从服务器get key</span><br><span class="line">​```shell</span><br><span class="line">[root@p2 redis-5.0.7]# redis-cli -a foo123</span><br><span class="line">127.0.0.1:6379&gt; get foo</span><br><span class="line">&quot;1&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@p3 redis-5.0.7]# redis-cli -a foo123</span><br><span class="line">127.0.0.1:6379&gt; get foo</span><br><span class="line">&quot;1&quot;</span><br></pre></td></tr></table></figure>

<p>通过在master 查看主从信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; INFO Replication</span><br><span class="line"><span class="meta">#</span><span class="bash"> Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:2</span><br><span class="line">min_slaves_good_slaves:2</span><br><span class="line">slave0:ip=182.0.0.11,port=6379,state=online,offset=1958,lag=0</span><br><span class="line">slave1:ip=182.0.0.12,port=6379,state=online,offset=1958,lag=1</span><br><span class="line">master_replid:1f69dd42ecea58d245859fd716c4eaee83a6e753</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:1958</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:1958</span><br></pre></td></tr></table></figure>
<p>注：INFO [section]命令可以查看多个部分信息，也可指定查看某个section的信息<br>以上说明1主两从redis架构已经构建，该模式下，只有master才能写数据，replica只能get数据。如果尝试在replica上写数据，将提示readonly：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="built_in">set</span> bar <span class="number">2</span></span><br><span class="line">(error) READONLY You can<span class="string">&#x27;t write against a read only replica.</span></span><br></pre></td></tr></table></figure>
<h4 id="4、sentinel-高可用配置"><a href="#4、sentinel-高可用配置" class="headerlink" title="4、sentinel 高可用配置"></a>4、sentinel 高可用配置</h4><p>&#8195;&#8195;sentinel 高可用是基于主-从-从正常运行情况下配置，经过前面2.3点，相信很容易理解该sentinel的逻辑，</p>
<h5 id="4-1-配置sentinel-conf"><a href="#4-1-配置sentinel-conf" class="headerlink" title="4.1 配置sentinel.conf"></a>4.1 配置sentinel.conf</h5><p>&#8195;&#8195;主、从的sentinel.conf都一样，而且也很简单，更改两项属性即可，其他可以按默认值，如果需要调优，可自行参考conf的说明设置相应值。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">bind 0.0.0.0</span><br><span class="line">port 26379</span><br><span class="line">daemonize yes</span><br><span class="line"><span class="meta">#</span><span class="bash"> sentinel monitor &lt;master-name&gt; &lt;ip&gt; &lt;redis-port&gt; &lt;quorum&gt;</span></span><br><span class="line">sentinel monitor  mymaster  182.0.0.10 6379 2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果master设置了密码，那么也告诉sentinel密码</span></span><br><span class="line">sentinel auth-pass mymaster foo123</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">  &lt;master-name&gt; 自行定义名称，这里使用mymaster默认值，后面的配置项都用了mymaster这个名，在django项目的settings，redis缓存设置也需要用到该master-name，无特殊需求不用改。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  &lt;quorum&gt; 裁定master挂了的最低通过票数</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Tells Sentinel to monitor this master, and to consider it <span class="keyword">in</span> O_DOWN</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> (Objectively Down) state only <span class="keyword">if</span> at least &lt;quorum&gt; sentinels agree.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 告诉Sentinel通监控master，如果有两个sentinel认为master挂了，说明master真的挂了</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="4-2-测试redis高可用"><a href="#4-2-测试redis高可用" class="headerlink" title="4.2 测试redis高可用"></a>4.2 测试redis高可用</h5><p>启动所有主从的sentinel 服务，注意如果用 redis-server启动命令，需要带上选项 —-sentinel</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@nn opt]# redis-server /opt/redis-5.0.7/sentinel.conf --sentinel</span><br><span class="line">或者使用</span><br><span class="line">[root@nn opt]# redis-sentinel /opt/redis-5.0.7/sentinel.conf</span><br></pre></td></tr></table></figure>
<p>在master上查看sentinel状态，只需连接sentinel的工作端口即可，可以看到该master下带了两个replica，状态正常：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[root@nn redis-5.0.7]# redis-cli -p 26379</span><br><span class="line">127.0.0.1:26379&gt; sentinel master mymaster</span><br><span class="line"> 1) &quot;name&quot;</span><br><span class="line"> 2) &quot;mymaster&quot;</span><br><span class="line"> 3) &quot;ip&quot;</span><br><span class="line"> 4) &quot;182.0.0.10&quot;</span><br><span class="line"> 5) &quot;port&quot;</span><br><span class="line"> 6) &quot;6379&quot;</span><br><span class="line"> 7) &quot;runid&quot;</span><br><span class="line"> 8) &quot;7cdc7e518b592168c94268f7d55fc2d237449118&quot;</span><br><span class="line"> 9) &quot;flags&quot;</span><br><span class="line">10) &quot;master&quot;</span><br><span class="line">11) &quot;link-pending-commands&quot;</span><br><span class="line">12) &quot;0&quot;</span><br><span class="line">13) &quot;link-refcount&quot;</span><br><span class="line">14) &quot;1&quot;</span><br><span class="line">15) &quot;last-ping-sent&quot;</span><br><span class="line">16) &quot;0&quot;</span><br><span class="line">17) &quot;last-ok-ping-reply&quot;</span><br><span class="line">18) &quot;516&quot;</span><br><span class="line">19) &quot;last-ping-reply&quot;</span><br><span class="line">20) &quot;516&quot;</span><br><span class="line">21) &quot;down-after-milliseconds&quot;</span><br><span class="line">22) &quot;30000&quot;</span><br><span class="line">23) &quot;info-refresh&quot;</span><br><span class="line">24) &quot;3335&quot;</span><br><span class="line">25) &quot;role-reported&quot;</span><br><span class="line">26) &quot;master&quot;</span><br><span class="line">27) &quot;role-reported-time&quot;</span><br><span class="line">28) &quot;113804&quot;</span><br><span class="line">29) &quot;config-epoch&quot;</span><br><span class="line">30) &quot;0&quot;</span><br><span class="line">31) &quot;num-slaves&quot;</span><br><span class="line">32) &quot;2&quot;</span><br><span class="line">33) &quot;num-other-sentinels&quot;</span><br><span class="line">34) &quot;1&quot;</span><br><span class="line">35) &quot;quorum&quot;</span><br><span class="line">36) &quot;2&quot;</span><br><span class="line">37) &quot;failover-timeout&quot;</span><br><span class="line">38) &quot;180000&quot;</span><br><span class="line">39) &quot;parallel-syncs&quot;</span><br><span class="line">40) &quot;1&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>查看两个replica上的sentinel服务也正常运行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:26379&gt; SENTINEL slaves mymaster</span><br><span class="line">1)  1) &quot;name&quot;</span><br><span class="line">    2) &quot;182.0.0.11:6379&quot;</span><br><span class="line">    3) &quot;ip&quot;</span><br><span class="line">    4) &quot;182.0.0.11&quot;</span><br><span class="line">    5) &quot;port&quot;</span><br><span class="line">    6) &quot;6379&quot;</span><br><span class="line">    7) &quot;runid&quot;</span><br><span class="line">    8) &quot;b7a9000c355584be472fe2409406b772b755b0ed&quot;</span><br><span class="line">    9) &quot;flags&quot;</span><br><span class="line">   10) &quot;slave&quot;</span><br><span class="line">   11) &quot;link-pending-commands&quot;</span><br><span class="line">   12) &quot;0&quot;</span><br><span class="line">   13) &quot;link-refcount&quot;</span><br><span class="line">   14) &quot;1&quot;</span><br><span class="line">   15) &quot;last-ping-sent&quot;</span><br><span class="line">   16) &quot;0&quot;</span><br><span class="line">   17) &quot;last-ok-ping-reply&quot;</span><br><span class="line">   18) &quot;430&quot;</span><br><span class="line">   19) &quot;last-ping-reply&quot;</span><br><span class="line">   20) &quot;430&quot;</span><br><span class="line">   21) &quot;down-after-milliseconds&quot;</span><br><span class="line">   22) &quot;30000&quot;</span><br><span class="line">   23) &quot;info-refresh&quot;</span><br><span class="line">   24) &quot;9197&quot;</span><br><span class="line">   25) &quot;role-reported&quot;</span><br><span class="line">   26) &quot;slave&quot;</span><br><span class="line">   27) &quot;role-reported-time&quot;</span><br><span class="line">   28) &quot;169854&quot;</span><br><span class="line">   29) &quot;master-link-down-time&quot;</span><br><span class="line">   30) &quot;0&quot;</span><br><span class="line">   31) &quot;master-link-status&quot;</span><br><span class="line">   32) &quot;ok&quot;</span><br><span class="line">   33) &quot;master-host&quot;</span><br><span class="line">   34) &quot;182.0.0.10&quot;</span><br><span class="line">   35) &quot;master-port&quot;</span><br><span class="line">   36) &quot;6379&quot;</span><br><span class="line">   37) &quot;slave-priority&quot;</span><br><span class="line">   38) &quot;100&quot;</span><br><span class="line">   39) &quot;slave-repl-offset&quot;</span><br><span class="line">   40) &quot;24585&quot;</span><br><span class="line">2)  1) &quot;name&quot;</span><br><span class="line">    2) &quot;182.0.0.12:6379&quot;</span><br><span class="line">    3) &quot;ip&quot;</span><br><span class="line">    4) &quot;182.0.0.12.5&quot;</span><br><span class="line">    5) &quot;port&quot;</span><br><span class="line">    6) &quot;6379&quot;</span><br><span class="line">    7) &quot;runid&quot;</span><br><span class="line">    8) &quot;39edb70865b99916b1fd0013740e457135fe42e4&quot;</span><br><span class="line">    9) &quot;flags&quot;</span><br><span class="line">   10) &quot;slave&quot;</span><br><span class="line">   11) &quot;link-pending-commands&quot;</span><br><span class="line">   12) &quot;0&quot;</span><br><span class="line">   13) &quot;link-refcount&quot;</span><br><span class="line">   14) &quot;1&quot;</span><br><span class="line">   15) &quot;last-ping-sent&quot;</span><br><span class="line">   16) &quot;0&quot;</span><br><span class="line">   17) &quot;last-ok-ping-reply&quot;</span><br><span class="line">   18) &quot;430&quot;</span><br><span class="line">   19) &quot;last-ping-reply&quot;</span><br><span class="line">   20) &quot;430&quot;</span><br><span class="line">   21) &quot;down-after-milliseconds&quot;</span><br><span class="line">   22) &quot;30000&quot;</span><br><span class="line">   23) &quot;info-refresh&quot;</span><br><span class="line">   24) &quot;9197&quot;</span><br><span class="line">   25) &quot;role-reported&quot;</span><br><span class="line">   26) &quot;slave&quot;</span><br><span class="line">   27) &quot;role-reported-time&quot;</span><br><span class="line">   28) &quot;169855&quot;</span><br><span class="line">   29) &quot;master-link-down-time&quot;</span><br><span class="line">   30) &quot;0&quot;</span><br><span class="line">   31) &quot;master-link-status&quot;</span><br><span class="line">   32) &quot;ok&quot;</span><br><span class="line">   33) &quot;master-host&quot;</span><br><span class="line">   34) &quot;182.0.0.10&quot;</span><br><span class="line">   35) &quot;master-port&quot;</span><br><span class="line">   36) &quot;6379&quot;</span><br><span class="line">   37) &quot;slave-priority&quot;</span><br><span class="line">   38) &quot;100&quot;</span><br><span class="line">   39) &quot;slave-repl-offset&quot;</span><br><span class="line">   40) &quot;24585&quot;</span><br></pre></td></tr></table></figure>



<p>高可用测试：</p>
<p>kill 掉master的redis-server进程和redis-sentinel进程，模拟master服务器宕机情况：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@nn redis-5.0.7]# ps -ef |grep redis</span><br><span class="line">root       7385      1  0 *        00:02:35 redis-server 0.0.0.0:6379</span><br><span class="line">root      20367  20127  0 *    00:00:00 redis-cli -a foo123</span><br><span class="line">root      23760      1  0 *       00:00:03 redis-sentinel 0.0.0.0:26379 [sentinel]</span><br><span class="line">[root@nn redis-5.0.7]# kill -9 7385</span><br><span class="line">[root@nn redis-5.0.7]# kill -9 23760</span><br></pre></td></tr></table></figure>

<p>在replica 1查看目前是否已转移到：可以看到两个replica已经选举出新的master</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost redis-5.0.7]# redis-cli -p 26379</span><br><span class="line">127.0.0.1:26379&gt; sentinel master mymaster</span><br><span class="line"> 1) &quot;name&quot;</span><br><span class="line"> 2) &quot;mymaster&quot;</span><br><span class="line"> 3) &quot;ip&quot;</span><br><span class="line"> 4) &quot;182.0.0.11&quot;</span><br><span class="line"> 5) &quot;port&quot;</span><br><span class="line"> 6) &quot;6379&quot;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>也可通过redis-cli上查看：目前182.0.0.11已成为新的master，有个正常连接的replica</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; info Replication</span><br><span class="line"><span class="meta">#</span><span class="bash"> Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:1</span><br><span class="line">min_slaves_good_slaves:1</span><br><span class="line">slave0:ip=182.0.0.12,port=6379,state=online,offset=146353,lag=1</span><br><span class="line">master_replid:4c1679086e6e4bb0bdd4956bcf979a6b964a8503</span><br><span class="line">master_replid2:ff0d944d22232a7b3489a8544c3109350aac6cd5</span><br><span class="line">master_repl_offset:146494</span><br><span class="line">second_repl_offset:145062</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:130700</span><br><span class="line">repl_backlog_histlen:15795</span><br></pre></td></tr></table></figure>

<p>在新maser set 值，可在剩余的一个replica get到相应的key</p>
<p>将原宕机的master恢复redis进程和sentinel进程，在新的master：182.0.0.11上，查看10节点已加入到replicas列表:<br>slave0:ip=182.0.0.12,port=6379,state=online,offset=211840,lag=1<br>slave1:ip=182.0.0.10,port=6379,state=online,offset=211840,lag=1</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:2</span><br><span class="line">min_slaves_good_slaves:2</span><br><span class="line">slave0:ip=182.0.0.12,port=6379,state=online,offset=211840,lag=1</span><br><span class="line">slave1:ip=182.0.0.10,port=6379,state=online,offset=211840,lag=1</span><br><span class="line">master_replid:4c1679086e6e4bb0bdd4956bcf979a6b964a8503</span><br><span class="line">master_replid2:ff0d944d22232a7b3489a8544c3109350aac6cd5</span><br><span class="line">master_repl_offset:211840</span><br><span class="line">second_repl_offset:145062</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:130700</span><br><span class="line">repl_backlog_histlen:81141</span><br></pre></td></tr></table></figure>
<p>以上完成redis 1主2从的高可用配置和测试，下面将在实际项目中引入。</p>
<h4 id="5、在python项目或者django的项目引入sentinel集群"><a href="#5、在python项目或者django的项目引入sentinel集群" class="headerlink" title="5、在python项目或者django的项目引入sentinel集群"></a>5、在python项目或者django的项目引入sentinel集群</h4><h5 id="5-1-python项目连接sentinel集群"><a href="#5-1-python项目连接sentinel集群" class="headerlink" title="5.1 python项目连接sentinel集群"></a>5.1 python项目连接sentinel集群</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">from</span> redis.sentinel <span class="keyword">import</span> Sentinel  </span><br><span class="line">In [<span class="number">4</span>]: st=Sentinel([(<span class="string">&#x27;182.0.0.10&#x27;</span>,<span class="number">26379</span>),(<span class="string">&#x27;182.0.0.11&#x27;</span>,<span class="number">26379</span>),(<span class="string">&#x27;182.0.0.12&#x27;</span>,<span class="number">26379</span>)]) </span><br><span class="line"></span><br><span class="line">In [<span class="number">7</span>]: st.discover_master(<span class="string">&#x27;mymaster&#x27;</span>)                                     </span><br><span class="line">Out[<span class="number">7</span>]: (<span class="string">&#x27;182.0.0.10&#x27;</span>, <span class="number">6379</span>)</span><br><span class="line">In [<span class="number">8</span>]: st.discover_slaves(<span class="string">&#x27;mymaster&#x27;</span>)                                     </span><br><span class="line">Out[<span class="number">8</span>]: [(<span class="string">&#x27;182.0.0.11&#x27;</span>, <span class="number">6379</span>), (<span class="string">&#x27;182.0.0.12&#x27;</span>, <span class="number">6379</span>)]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>查看用法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [5]: ?st.master_for                                                                               </span><br><span class="line">Signature:</span><br><span class="line">st.master_for(</span><br><span class="line">    service_name,</span><br><span class="line">    redis_class=&lt;class &#x27;redis.client.Redis&#x27;&gt;,</span><br><span class="line">    connection_pool_class=&lt;class &#x27;redis.sentinel.SentinelConnectionPool&#x27;&gt;,</span><br><span class="line">    **kwargs,</span><br><span class="line">)</span><br><span class="line">Docstring:</span><br><span class="line">Returns a redis client instance <span class="keyword">for</span> the ``service_name`` master.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>创建连接实例，kwargs参数跟redis.Redis入参一致</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意别漏了sentinel集群设了密码</span></span><br><span class="line">In [<span class="number">9</span>]: master_rd=st.master_for(service_name=<span class="string">&#x27;mymaster&#x27;</span>,password=<span class="string">&#x27;foo123&#x27;</span>,db=<span class="number">0</span>)  </span><br><span class="line">In [<span class="number">10</span>]: replica_rd=st.slave_for(service_name=<span class="string">&#x27;mymaster&#x27;</span>,password=<span class="string">&#x27;foo123&#x27;</span>,db=<span class="number">0</span>) </span><br><span class="line"></span><br><span class="line">In [<span class="number">19</span>]: master_rd              </span><br><span class="line">Out[<span class="number">19</span>]: Redis&lt;SentinelConnectionPool&lt;service=mymaster(master)&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 向master写数据，不仅实现高可用，而且还实现读写分离</span></span><br><span class="line">In [<span class="number">23</span>]: master_rd.<span class="built_in">set</span>(<span class="string">&#x27;redis-HA&#x27;</span>,<span class="string">&#x27;good&#x27;</span>)                 </span><br><span class="line">Out[<span class="number">23</span>]: <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">24</span>]: master_rd.get(<span class="string">&#x27;redis-HA&#x27;</span>)                </span><br><span class="line">Out[<span class="number">24</span>]: <span class="string">b&#x27;good&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果尝试向replica写数据则出错提示：replica只能读数据</span></span><br><span class="line">In [<span class="number">25</span>]: replica_rd.<span class="built_in">set</span>(<span class="string">&#x27;foo&#x27;</span>,<span class="string">&#x27;HA&#x27;</span>)    </span><br><span class="line">ReadOnlyError: You can<span class="string">&#x27;t write against a read only replica.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 从replica读数据，不仅实现高可用，而且还实现读写分离</span></span><br><span class="line"><span class="string">In [28]: replica_rd.get(&#x27;</span>redis-HA<span class="string">&#x27;)            </span></span><br><span class="line"><span class="string">Out[28]: b&#x27;</span>good<span class="string">&#x27;</span></span><br></pre></td></tr></table></figure>

<p>在服务器上把当前10节点master kill掉，再看看python取值是否被影响</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 经过3秒左右，再次获取最新的master可以看到已转移到11节点上，所以这3秒时间实际也是丢失数据的时间窗口</span></span><br><span class="line">In [<span class="number">43</span>]: st.discover_master(<span class="string">&#x27;mymaster&#x27;</span>)                                     Out[<span class="number">43</span>]: (<span class="string">&#x27;182.0.0.11&#x27;</span>, <span class="number">6379</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 当前集群仅有一个replica</span></span><br><span class="line">In [<span class="number">44</span>]: st.discover_slaves(<span class="string">&#x27;mymaster&#x27;</span>)</span><br><span class="line">Out[<span class="number">44</span>]: [(<span class="string">&#x27;182.0.0.12&#x27;</span>, <span class="number">6379</span>)]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 主从切换后，不影响程序获取原有数据</span></span><br><span class="line">In [<span class="number">45</span>]: master_rd.get(<span class="string">&#x27;redis-HA&#x27;</span>)             </span><br><span class="line">Out[<span class="number">45</span>]: <span class="string">b&#x27;good&#x27;</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">47</span>]: master_rd.<span class="built_in">set</span>(<span class="string">&#x27;bar&#x27;</span>,<span class="string">&#x27;test&#x27;</span>)               </span><br><span class="line">Out[<span class="number">47</span>]: <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">48</span>]: replica_rd.get(<span class="string">&#x27;bar&#x27;</span>)         </span><br><span class="line">Out[<span class="number">48</span>]: <span class="string">b&#x27;test&#x27;</span></span><br></pre></td></tr></table></figure>
<h5 id="5-2-django项目中使用引入sentinel集群"><a href="#5-2-django项目中使用引入sentinel集群" class="headerlink" title="5.2 django项目中使用引入sentinel集群"></a>5.2 django项目中使用引入sentinel集群</h5><h6 id="5-2-1-单redis实例"><a href="#5-2-1-单redis实例" class="headerlink" title="5.2.1 单redis实例"></a>5.2.1 单redis实例</h6><p>在Django项目开发中，一般可以redis作为django后端cache的中间件，很多需求可以满足：例如验证码、session、缓存查询数据等。</p>
<p>首先需要django-redis这个库支持：pip install django-redis，具体用法参考<a target="_blank" rel="noopener" href="http://niwinz.github.io/django-redis/latest/">官方doc</a></p>
<p>如果是单实例redis，在setting的设置相对简单：redis的0号db作为默认缓存，1号db作为hp这个App的数据缓存</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将redis设为django缓存</span></span><br><span class="line">CACHES = &#123;</span><br><span class="line">    <span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;BACKEND&#x27;</span>: <span class="string">&#x27;django_redis.cache.RedisCache&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;LOCATION&#x27;</span>: [<span class="string">&#x27;redis://182.0.0.10:6379/0&#x27;</span>], //连接redis url</span><br><span class="line">        <span class="string">&#x27;KEY_PREFIX&#x27;</span>: <span class="string">&#x27;dj&#x27;</span>,   //前缀名</span><br><span class="line">        <span class="string">&#x27;OPTIONS&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;CLIENT_CLASS&#x27;</span>: <span class="string">&#x27;django_redis.client.DefaultClient&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;CONNECTTON_POOL_KWARGS&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;max_connections&#x27;</span>: <span class="number">128</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;PASSWORD&#x27;</span>: <span class="string">&#x27;foo123&#x27;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;hp&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;BACKEND&#x27;</span>: <span class="string">&#x27;django_redis.cache.RedisCache&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;LOCATION&#x27;</span>: [<span class="string">&#x27;redis://182.0.0.10:6379/1&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;KEY_PREFIX&#x27;</span>: <span class="string">&#x27;dj:bi&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;OPTIONS&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;CLIENT_CLASS&#x27;</span>: <span class="string">&#x27;django_redis.client.DefaultClient&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;CONNECTTON_POOL_KWARGS&#x27;</span>: &#123;</span><br><span class="line">                    <span class="string">&#x27;max_connections&#x27;</span>: <span class="number">128</span>,</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&#x27;PASSWORD&#x27;</span>: <span class="string">&#x27;foo123&#x27;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">SESSION_ENGINE = <span class="string">&#x27;django.contrib.sessions.backends.cache&#x27;</span></span><br><span class="line"><span class="comment">#django自身运行上下文使用默认数据库redis缓存</span></span><br><span class="line">SESSION_CACHE_ALIAS = <span class="string">&#x27;default&#x27;</span>  </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>启动django shell测试：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@nn hp]<span class="comment"># python manage.py shell</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">3</span>]: <span class="keyword">from</span> django.core.cache <span class="keyword">import</span> cache,caches     </span><br><span class="line">In [<span class="number">4</span>]: cache.<span class="built_in">set</span>(<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;fofo&#x27;</span>)                     </span><br><span class="line">Out[<span class="number">4</span>]: <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用default 库</span></span><br><span class="line">In [<span class="number">5</span>]: cache.get(<span class="string">&#x27;name&#x27;</span>)                                                   </span><br><span class="line">Out[<span class="number">5</span>]: <span class="string">&#x27;fofo&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用hp 库</span></span><br><span class="line">In [<span class="number">11</span>]: caches[<span class="string">&#x27;hp&#x27;</span>].<span class="built_in">set</span>(<span class="string">&#x27;code&#x27;</span>,<span class="number">133</span>)                                       </span><br><span class="line">Out[<span class="number">11</span>]: <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">12</span>]: caches[<span class="string">&#x27;hp&#x27;</span>].get(<span class="string">&#x27;code&#x27;</span>)                                           </span><br><span class="line">Out[<span class="number">12</span>]: <span class="number">133</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注意：如果使用cache方法，则默认使用default数据库，若需要使用其他名称的数据，需要用caches方法，并通过settings里面redis数据库名称来索引</p>
<p>在redis服务器查看default库相应的key：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) &quot;bar&quot;</span><br><span class="line">2) &quot;redis-HA&quot;</span><br><span class="line">3) &quot;dj:1:name&quot;</span><br></pre></td></tr></table></figure>
<p>因为在cache里面设置key的前缀为dj，加上cache会给key再打上<code>:1:</code>这个默认前缀，故实际存储的完整key名称:”dj:1:name”<br>同理查看db1号库的key</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; SELECT 1</span><br><span class="line">OK</span><br><span class="line"> </span><br><span class="line">127.0.0.1:6379[1]&gt; keys *</span><br><span class="line">1) &quot;dj:bi:1:code&quot;</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379[1]&gt; get dj:bi:1:code</span><br><span class="line">&quot;133&quot;</span><br></pre></td></tr></table></figure>

<p>若Django项目中需要使用更多进阶的原生client功能连接redis（支持redis所有方法)），需使用get_redis_connection，建议在实际项目使用该方法获取redis连接对象。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">13</span>]: <span class="keyword">from</span> django_redis <span class="keyword">import</span> get_redis_connection</span><br><span class="line">In [<span class="number">14</span>]: conn = get_redis_connection()                                     </span><br><span class="line">In [<span class="number">15</span>]: conn.<span class="built_in">set</span>(<span class="string">&#x27;fb&#x27;</span>,<span class="number">12</span>)                                                 </span><br><span class="line">Out[<span class="number">15</span>]: <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">16</span>]: conn.get(<span class="string">&#x27;fb&#x27;</span>)                                                     </span><br><span class="line">Out[<span class="number">16</span>]: <span class="string">b&#x27;12&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="5-2-2-django项目的cache引入sentinel模式"><a href="#5-2-2-django项目的cache引入sentinel模式" class="headerlink" title="5.2.2  django项目的cache引入sentinel模式"></a>5.2.2  django项目的cache引入sentinel模式</h6><p>该模式需要安装新的django插件，<a target="_blank" rel="noopener" href="https://github.com/KabbageInc/django-redis-sentinel">github地址</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install django-redis-sentinel</span><br><span class="line"><span class="meta">#</span><span class="bash">或者pip install django-redis-sentinel-redux 0.2.0</span> </span><br></pre></td></tr></table></figure>
<p>这个插件其实封装了redis.sentinel将其作为django_redis的插件之一，注意，该插件已不再维护，如果在重要项目上，不建议使用。（重要项目直接用codis，或者redis-cluster，以便可以pip install到相关的redis连接插件，或者自己参考模板写一个）</p>
<p>在setting.py中cache的设置：<br>Location 格式: master_name/sentinel_server:port,sentinel_server:port/db_id</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CACHES = &#123;</span><br><span class="line">        <span class="string">&quot;default&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;BACKEND&quot;</span>: <span class="string">&quot;django_redis.cache.RedisCache&quot;</span>,</span><br><span class="line">            <span class="string">&quot;LOCATION&quot;</span>: <span class="string">&quot;mymaster/188.0.0.10:26379,188.0.0.11:26379,188.0.0.12:26379/0&quot;</span></span><br><span class="line">            <span class="string">&quot;OPTIONS&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;PASSWORD&quot;</span>: <span class="string">&#x27;foo123&#x27;</span>,</span><br><span class="line">                <span class="string">&quot;CLIENT_CLASS&quot;</span>: <span class="string">&quot;django_redis_sentinel.SentinelClient&quot;</span>,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>该 django-redis-sentinel的插件代码实现不到120行，主要看看connect方法，写数据时用sentinel.discover_master(master_name)获取master去写，读数据时，随机取一个replica 读数据random.choice(sentinel.discover_slaves(master_name))</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">connect</span>(<span class="params">self, write=<span class="literal">True</span>, SentinelClass=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Creates a redis connection with connection pool.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> SentinelClass <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        SentinelClass = Sentinel</span><br><span class="line">    self.log.debug(<span class="string">&quot;connect called: write=%s&quot;</span>, write)</span><br><span class="line">    master_name, sentinel_hosts, db = self.parse_connection_string(self._connection_string)</span><br><span class="line"></span><br><span class="line">    sentinel_timeout = self._options.get(<span class="string">&#x27;SENTINEL_TIMEOUT&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">    password = self._options.get(<span class="string">&#x27;PASSWORD&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">    sentinel = SentinelClass(sentinel_hosts,</span><br><span class="line">                             socket_timeout=sentinel_timeout,</span><br><span class="line">                             password=password)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> write:</span><br><span class="line">        host, port = sentinel.discover_master(master_name)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            host, port = random.choice(sentinel.discover_slaves(master_name))</span><br><span class="line">        <span class="keyword">except</span> IndexError:</span><br><span class="line">            self.log.debug(<span class="string">&quot;no slaves are available. using master for read.&quot;</span>)</span><br><span class="line">            host, port = sentinel.discover_master(master_name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> password:</span><br><span class="line">        connection_url = <span class="string">&quot;redis://:%s@%s:%s/%s&quot;</span> % (password, host, port, db)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        connection_url = <span class="string">&quot;redis://%s:%s/%s&quot;</span> % (host, port, db)</span><br><span class="line">    <span class="keyword">return</span> self.connection_factory.connect(connection_url)</span><br></pre></td></tr></table></figure>

<p>注意：如果使用sentinel这个插件，那么需使用django_redis的get_redis_connection，而不是使用django.core.cache的cache</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">1</span>]: <span class="keyword">from</span> django_redis <span class="keyword">import</span> get_redis_connection   </span><br><span class="line">In [<span class="number">2</span>]: conn = get_redis_connection()       </span><br><span class="line">In [<span class="number">3</span>]: conn.<span class="built_in">set</span>(<span class="string">&#x27;apple&#x27;</span>,<span class="string">&#x27;airpods&#x27;</span>)               </span><br><span class="line">Out[<span class="number">3</span>]: <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">4</span>]: conn.get(<span class="string">&#x27;apple&#x27;</span>)                              </span><br><span class="line">Out[<span class="number">4</span>]: <span class="string">b&#x27;airpods&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注意：get_redis_connection()有bug，当使用conn实例获取哨兵集群的master或者replica，get_redis_connection()调用了<code>your pythonpath/python3.7/site-packages/redis/client.py </code>里面的<code> self.execute_command(&#39;SENTINEL MASTER&#39;, service_name)</code>，然而该方法是在6379端口连接的client执行<code>SENTINEL MASTER mymaster</code>，由于所有的SENTINEL 命令只能在26379端口下启动的client才能执行，因此直接用get_redis_connection()获取sentinel信息会提示未知命令：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">8</span>]: conn.sentinel_master(<span class="string">&#x27;mymaster&#x27;</span>) </span><br><span class="line">ResponseError: unknown command `SENTINEL`, <span class="keyword">with</span> args beginning <span class="keyword">with</span>: `MASTER`, `mymaster`, </span><br></pre></td></tr></table></figure>

<p>测试以上出错信息也简单：连接redis-server的6379端口client</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost redis-5.0.7]# redis-cli -a foo123 </span><br><span class="line">127.0.0.1:6379&gt; sentinel master mymaster</span><br><span class="line">(error) ERR unknown command `sentinel`, with args beginning with: `master`, `mymaster`, </span><br></pre></td></tr></table></figure>

<p>由于sentinel集群监听的是26379端口来执行有关查询命令（端口号在sentinel.conf文件配置），而get_redis_connection()使用的是6379，用此报错。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost redis-5.0.7]# redis-cli -a foo123 -p 26379</span><br><span class="line">127.0.0.1:26379&gt; sentinel master mymaster</span><br><span class="line"> 1) &quot;name&quot;</span><br><span class="line"> 2) &quot;mymaster&quot;</span><br><span class="line"> 3) &quot;ip&quot;</span><br><span class="line"> 4) &quot;188.0.0.10&quot;</span><br><span class="line"> 5) &quot;port&quot;</span><br><span class="line"> 6) &quot;6379&quot;</span><br><span class="line"> 7) &quot;runid&quot;</span><br><span class="line"> 8) &quot;5537ec765629633406942061f5993e475c42df8e&quot;</span><br><span class="line"> 9) &quot;flags&quot;</span><br><span class="line">10) &quot;master&quot;</span><br></pre></td></tr></table></figure>
<p>解决办法有三种种：<br>第一种：修改redis源码，改get_redis_connection，也不难<br>第二种：sentinel监听端口设为默认6379，redis-server设为其他端口号即可<br>第三种：不需要使用django redis插件，直接用redis原生库自行封装相关sentinel的操作</p>
<p>&#8195;&#8195;综上完成基于sentinel模式的redisHA配置以及详细解释了在python项目和django项目中如何使用sentinel集群模式，个人认为，目前该方案足够支持大部分中小企业内部自行开发项目。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Sentinel%E6%A8%A1%E5%BC%8F/" rel="tag"># Sentinel模式</a>
              <a href="/tags/redis%E9%9B%86%E7%BE%A4/" rel="tag"># redis集群</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2019/12/18/%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90Python%E5%85%83%E7%B1%BB%E4%BD%9C%E7%94%A8/" rel="prev" title="深入解析Python元类作用">
      <i class="fa fa-chevron-left"></i> 深入解析Python元类作用
    </a></div>
      <div class="post-nav-item">
    <a href="/2019/12/22/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Spark/" rel="next" title="深入理解Spark">
      深入理解Spark <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81%E5%AE%89%E8%A3%85redis"><span class="nav-number">1.</span> <span class="nav-text">1、安装redis</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81Sentinel-%E7%9A%84%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E"><span class="nav-number">2.</span> <span class="nav-text">2、Sentinel 的配置说明</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#2-1-%E5%AE%98%E7%BD%91%E6%9C%89%E5%85%B3Sentinel%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 官网有关Sentinel模式的基本信息</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-redis%E5%AE%98%E7%BD%91Sentinel%E6%A8%A1%E5%BC%8F%E8%AF%B4%E6%98%8E"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 redis官网Sentinel模式说明</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81%E4%B8%80%E4%B8%BB%E4%B8%A4%E4%BB%8E%E7%9A%84redis%E6%9E%B6%E6%9E%84%E9%85%8D%E7%BD%AE"><span class="nav-number">3.</span> <span class="nav-text">3、一主两从的redis架构配置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#3-1-%E9%85%8D%E7%BD%AE%E4%B8%BB%E4%BB%8E%E7%9A%84redis-conf%E6%96%87%E4%BB%B6"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 配置主从的redis.conf文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-2-%E5%90%AF%E5%8A%A8%E5%92%8C%E6%B5%8B%E8%AF%95%E4%B8%BB%E4%BB%8E"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 启动和测试主从</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4%E3%80%81sentinel-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%85%8D%E7%BD%AE"><span class="nav-number">4.</span> <span class="nav-text">4、sentinel 高可用配置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#4-1-%E9%85%8D%E7%BD%AEsentinel-conf"><span class="nav-number">4.1.</span> <span class="nav-text">4.1 配置sentinel.conf</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-2-%E6%B5%8B%E8%AF%95redis%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="nav-number">4.2.</span> <span class="nav-text">4.2 测试redis高可用</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5%E3%80%81%E5%9C%A8python%E9%A1%B9%E7%9B%AE%E6%88%96%E8%80%85django%E7%9A%84%E9%A1%B9%E7%9B%AE%E5%BC%95%E5%85%A5sentinel%E9%9B%86%E7%BE%A4"><span class="nav-number">5.</span> <span class="nav-text">5、在python项目或者django的项目引入sentinel集群</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#5-1-python%E9%A1%B9%E7%9B%AE%E8%BF%9E%E6%8E%A5sentinel%E9%9B%86%E7%BE%A4"><span class="nav-number">5.1.</span> <span class="nav-text">5.1 python项目连接sentinel集群</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-2-django%E9%A1%B9%E7%9B%AE%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%BC%95%E5%85%A5sentinel%E9%9B%86%E7%BE%A4"><span class="nav-number">5.2.</span> <span class="nav-text">5.2 django项目中使用引入sentinel集群</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#5-2-1-%E5%8D%95redis%E5%AE%9E%E4%BE%8B"><span class="nav-number">5.2.1.</span> <span class="nav-text">5.2.1 单redis实例</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#5-2-2-django%E9%A1%B9%E7%9B%AE%E7%9A%84cache%E5%BC%95%E5%85%A5sentinel%E6%A8%A1%E5%BC%8F"><span class="nav-number">5.2.2.</span> <span class="nav-text">5.2.2  django项目的cache引入sentinel模式</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt=""
      src="https://www.linuxprobe.com/wp-content/uploads/2018/06/QQ%E5%9B%BE%E7%89%8720180625205006.png">
  <p class="site-author-name" itemprop="name"></p>
  <div class="site-description" itemprop="description">一个非常专注技术总结与分享的博客</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">48</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">48</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yield-bytes</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">577k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">8:44</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  




  
<script src="/js/local-search.js"></script>













    <div id="pjax">
  

  

  

    </div>
</body>
</html>
